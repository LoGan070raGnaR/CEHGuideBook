# Malware Threats

## Objectives

- Creating a Trojan and exploiting a target machine
- Developing a virus to infect a target machine
- Performing malware analysis to understand origin, functionality, and potential impact
- Detecting and defending against malware

## Overview of Malware

Malware, including viruses, worms, Trojans, ransomware, and more, can compromise computer systems, leading to data theft or fraud. Here, we explores the various malicious activities that malware can perform, from simple advertising to complex identity theft.

## Malware Programmers' Intentions

Malware developers use their creations to:
- Attack browsers and track websites
- Degrade system performance
- Cause hardware failure
- Steal personal information
- Erase valuable data
- Launch attacks from compromised systems
- Spam inboxes with advertising emails

## Tools

#### 1. Gain Access using Trojans

- Gain control with njRAT RAT Trojan
- Hide a Trojan using SwayzCryptor
- Create a Trojan server using Theaf RAT Trojan

#### 2. Infect the Target System using a Virus

- Create a virus using JPS Virus maker tool

#### 3. Perform Static Malware Analysis

- Scan for malware using Hybrid Analysis
- Search for strings using BinText
- Identify packaging and obfuscation methods using PEid
- Analyze ELF Executable Files using Detect It Easy (DIE)
- Find PE Information using PE Explorer
- Identify file dependencies using Dependency Walker
- Perform malware disassembly using IDA and OllyDbg
- Perform malware disassembly using Ghidra

#### 4. Perform Dynamic Malware Analysis

- Monitor ports using TCPView and CurrPorts
- Monitor processes using Process Monitor
- Monitor registry using Reg Organizer
- Monitor Windows services using Windows Service Manager (SrvMan)
- Monitor startup programs using Autoruns for Windows and WinPatrol
- Monitor installations using Mirekusoft Install Monitor
- Monitor files and folders using PA File Sight
- Monitor device drivers using DriverView and Driver Reviver
- Monitor DNS using DNSQuerySniffer

---

### 1. Gaining Access to the Target System using Trojans

- A computer Trojan is a deceptive program with malicious code disguised within seemingly harmless data or programming. Attackers use these digital Trojan horses to trick victims into specific actions, granting them unauthorized access to sensitive data and potentially causing severe damage.

- Attackers leverage Trojans by enticing victims to perform predefined actions, such as installing seemingly harmless software or clicking on malicious links. Once activated, Trojans can provide attackers with unrestricted access to compromised information systems.

##### Trojan Overview

- In Ancient Greek mythology, the Greeks used a giant wooden horse to win the Trojan War. Similarly, a computer Trojan is a program where malicious code is concealed within seemingly harmless data, gaining control and causing damage.

**Key Considerations:**

- Trojans operate at the victim's privilege level, inheriting their capabilities.
- Trojans can attempt privilege escalation, exploiting vulnerabilities to increase access.

---

### 2. Infect the Target System using a Virus

- Computer viruses, a self-replicating programs that can cause substantial harm to both business and personal computers. The objective is to understand their behavior, test detection mechanisms, and assess the potential impact on a target system.

- Computer viruses, akin to biological viruses, can replicate and spread within a system, attaching copies of themselves to executable codes. Their longevity depends on their ability to reproduce, making them a persistent threat in the computing landscape.

##### Viruses and Worms Overview

- Viruses can infiltrate a target system through various methods, attaching themselves to programs and leveraging specific events for transmission. These events, such as email attachments, web interactions, or pop-ups, trigger the virus to activate. The virus then attacks system programs, data files, antivirus software, and system startup settings.

- Worms, a subtype of viruses, operate independently and can replicate and spread across network connections without human intervention. Their propagation can overload network servers, web servers, and individual computer systems, causing disruptions.

---

### 3. Static Malware Analysis

- Malware analysis is crucial for understanding the origin, functionality, and potential impact of malicious software. Here, we focuses on static malware analysis, a non-execution-based approach, to gain insights into malware behavior and characteristics.

##### Overview of Static Malware Analysis

- Static malware analysis involves examining the executable binary code without execution. It helps reveal details about the malware's functionality, packaging techniques, dependencies, and more. Various tools and techniques are employed in this process, ensuring a comprehensive understanding of the malware's characteristics. 
- Some key static malware analysis techniques include file fingerprinting, malware scanning, strings searching, identifying packing methods, finding PE information, identifying file dependencies, and malware disassembly.

- Static malware analysis provides essential insights into the inner workings of malicious software.

---
#### Malware Scanning using Hybrid Analysis

- [Hybrid Analysis](https://www.hybrid-analysis.com) is a valuable free service designed for analyzing suspicious files and URLs, aiding in the rapid detection of various threats like viruses, worms, Trojans, and other malware types.

##### Steps

- Navigate to [Hybrid Analysis](https://www.hybrid-analysis.com).
- Access the "Drag & Drop For Instant Analysis" section.
- Upload the virus file (tini.exe) from the specified directory.

- Select Analysis Environment:
   - Choose "Windows 7 64 bit" as the analysis environment.
   - Click "Generate Public Report."

- Once the analysis is complete, review the Analysis Overview page.
- Check for threat score, SHA value, and other details.

- Explore Anti-Virus Results:
   - Explore Anti-Virus Results section for insights from various sources.
   - Click on links to view detailed reports from vendors like VirusTotal.

- Detailed Analysis with VirusTotal:
   - View the detailed VirusTotal report, including detection information from multiple anti-virus solutions.

- Explore File Details:
   - Navigate through the DETECTION, DETAILS, and RELATIONS tabs for extensive file details.
   - Scroll through additional information on Hashes, Falcon reports, and Incident Response.

- **Alternative Scanning Options:**
    - Additionally, consider other local and online scanning tools for comprehensive analysis:
        - [Valkyrie](https://valkyrie.comodo.com)
        - [Cuckoo Sandbox](https://cuckoosandbox.org)
        - [Jotti](https://virusscan.jotti.org)
        - [iobit Cloud](https://cloud.iobit.com)

---

#### Strings Search using BinText

- Strings within software programs convey essential information about their functionality and purpose. In the context of malware analysis, searching for strings is a critical step to unveil potential malicious intent embedded in compiled binary code. BinText, a text extractor tool, proves instrumental in extracting plain ASCII text, Unicode text, and Resource strings from files, providing valuable insights during malware analysis.

- **Other String Search Tools:**
   - Consider using other string searching tools for a comprehensive analysis:
      - [FLOSS](https://www.fireeye.com)
      - [Strings](https://docs.microsoft.com)
      - [Free EXE DLL Resource Extract](https://www.resourceextract.com)
      - [FileSeek](https://www.fileseek.ca)

---

#### Analyze ELF Executable File using Detect It Easy (DIE)

- The analysis of ELF (Executable and Linkable Format) files in Linux environments involves investigating key components such as the ELF header, sections, and segments. Detect It Easy (DIE) is a versatile tool designed for determining file types, including ELF files. It utilizes a signature-based detection method to identify a file's compiler, linker, packer, etc.

- **Other Tools:**
    - Consider exploring other packaging/obfuscation tools such as [Macro_Pack](https://github.com/sevagas/macro_pack), [UPX](https://upx.github.io/), or [ASPack](http://www.aspack.com) to identify packing/obfuscation methods.

---

#### Find the Portable Executable (PE) Information of a Malware Executable File using PE Explorer

- The Portable Executable (PE) format is essential for Windows OS executable files, containing metadata crucial for managing the executable code. PE Explorer is a tool designed for opening, viewing, and editing various 32-bit Windows executable file types, providing insights into details like creation time, modification time, import/export functions, and more.


- **Other Tools:**
   - Consider exploring other PE extraction tools such as [Portable Executable Scanner (pescan)](https://tzworks.net), [Resource Hacker](http://www.angusj.com), or [PEView](https://www.aldeid.com) for additional insights.

---

#### Identify File Dependencies using Dependency Walker

- Software programs rely on various inbuilt OS libraries to perform specific actions on a system. Understanding file dependencies is crucial for analyzing malware, as it reveals the internal system files required for the program to function correctly. Dependency Walker is a tool that lists dependent modules of an executable file, including hierarchical tree diagrams, exported and called functions, and potential application problems.

- **Other Tools:**
   - Consider using other dependency checking tools like [Dependency-check](https://jeremylong.github.io), [Snyk](https://snyk.io), or [RetireJS](https://retirejs.github.io) for identifying file dependencies.

---

### 4. Dynamic Malware Analysis

- Dynamic Malware Analysis, also known as behavioral analysis, is a crucial process in understanding the behavior of malware by observing its actions in a controlled environment. This method involves executing malware code to analyze its impact on the host system.

- Dynamic analysis entails executing malware to scrutinize its conduct, operations, and identifying technical signatures that confirm malicious intent. This process reveals valuable information such as domain names, file paths, registry keys, IP addresses, installation files, and DLLs. It requires a secure environment with tools that can meticulously capture every movement of the malware without allowing it to spread.

- Malware Analysis techniques and associated tools:

---

| Technique                    | Tool(s)                                         |
|-----------------------------|-------------------------------------------------|
| Port Monitoring             | - TCPView<br>- CurrPorts                        |
| Process Monitoring          | - Process Monitor                                |
| Registry Monitoring         | - Reg Organizer                                  |
| Windows Services Monitoring | - Windows Service Manager (SrvMan)              |
| Startup Program Monitoring   | - Autoruns for Windows<br>- WinPatrol           |
| Installation Monitoring      | - Mirekusoft Install Monitor                    |
| Files and Folder Monitoring  | - PA File Sight                                  |
| Device Driver Monitoring     | - DriverView<br>- Driver Reviver                |
| DNS Monitoring               | - DNSQuerySniffer                                |

---

- Dynamic analysis provides insights into malware activities, including created files, accessed ports and URLs, executed functions, accessed applications and tools, information transfer, modified settings, started processes and services, among others.

##### Key steps

1. **System Baselining:**
   - Capture the system state (snapshot) at the beginning of the malware analysis, recording file system details, registry, open ports, and network activity.

2. **Host Integrity Monitoring:**
   - Use the same tools to take snapshots before and after incidents to analyze changes, evaluating the malware's impact on the system. Monitoring includes:
     - Port monitoring
     - Process monitoring
     - Registry monitoring
     - Windows services monitoring
     - Startup program monitoring
     - Event logs monitoring and analysis
     - Installation monitoring
     - Files and folder monitoring
     - Device driver monitoring
     - Network traffic monitoring and analysis
     - DNS monitoring and resolution
     - API calls monitoring

---
#### Port Monitoring using TCPView and CurrPorts

- The Internet relies on the TCP/IP protocol for data transfer. Malware often exploits system vulnerabilities by opening ports to establish connections with remote systems. Monitoring these ports is crucial for identifying and preventing malicious activities. Tools like TCPView and CurrPorts can assist in this process.

##### TCPView

- TCPView is a Windows program displaying detailed listings of TCP and UDP endpoints on a system. It provides information such as local and remote addresses and the state of TCP connections. Tcpvcon, a command-line version, is also included.

   - Shows detailed listings of all TCP and UDP endpoints.
   - Displays local and remote addresses, and connection states.
   - Enumerates all active TCP and UDP endpoints.

##### CurrPorts

- CurrPorts is network monitoring software that lists open TCP/IP and UDP ports on a local computer. It provides information about the process associated with each port, including name, path, version, creation time, and user.

   - Displays open TCP/IP and UDP ports on a local computer.
   - Provides information about the process associated with each port.
   - Allows closing unwanted connections and saving port information.

**Other tools:**

- It's recommended to use other port monitoring tools like [Port Monitor](https://www.portmonitor.com), [TCP Port Monitoring](https://www.dotcom-monitor.com), or [PortExpert](https://www.kcsoftwares.com) for a comprehensive analysis.

---

#### Process Monitoring using Process Monitor

- Process monitoring is crucial for understanding the processes initiated by malware, observing child processes, associated handles, loaded libraries, functions, and execution flow of boot time processes. This helps define the entire nature of a file or program, gathering information about processes running before and after malware execution. The Process Monitor tool is a powerful Windows utility for real-time monitoring of file system, Registry, and process/thread activities.

**Explore Other Tools:**
   - Consider using other process monitoring tools such as [Process Explorer](https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer), [OpManager](https://www.manageengine.com), [Monit](https://mmonit.com), or [ESET SysInspector](https://www.eset.com) for further analysis.

---

#### Registry Monitoring using Reg Organizer

- The Windows Registry stores OS and program configuration details, making it a critical area for malware analysis. Monitoring registry entries is a powerful way to track system modifications and detect malware. Tools like Reg Organizer simplify the process, providing an effective means of troubleshooting and monitoring changes.

**Explore Other Tools:**
    - Consider using other registry monitoring tools such as [RegShot](https://sourceforge.net/projects/regshot/), [Registry Viewer](https://accessdata.com), [RegScanner](https://www.nirsoft.net), or [Registrar Registry Manager](https://www.resplendence.com) for further analysis.

---
#### Windows Services Monitoring using Windows Service Manager (SrvMan)

- Attackers often deploy malware in the form of services on computer devices, allowing them to execute harmful activities discreetly. These malicious services, running in the background, can be challenging to detect as they operate invisibly and may even function without user intervention. To analyze and trace such services during dynamic analysis, Windows Service Manager tools like SrvMan can be invaluable. SrvMan helps identify changes in services and scan for suspicious Windows services.

**Explore Other Tools:**
    - Consider using alternative Windows service monitoring tools such as [Advanced Windows Service Manager](https://securityxploded.com), [Process Hacker](https://processhacker.sourceforge.io), [Netwrix Service Monitor](https://www.netwrix.com), or [AnVir Task Manager](https://www.anvir.com) for comprehensive Windows services monitoring.

---

#### Startup Program Monitoring using Autoruns for Windows and WinPatrol

- Startup programs, the applications or processes that initiate when a system boots up, are often exploited by attackers to execute malicious programs discreetly. Identifying and removing unwanted or malicious startup programs is crucial for maintaining system security. Here, we perform manual scanning for suspicious startup programs and utilizing monitoring tools like Autoruns for Windows and WinPatrol.

**Explore Other Tools:**
    - Consider using other Windows startup programs monitoring tools such as [Autorun Organizer](https://www.chemtable.com), [Quick Startup](https://www.glarysoft.com), or [Chameleon Startup Manager](https://www.chameleon-managers.com) for comprehensive monitoring.

---

#### Installation Monitoring using Mirekusoft Install Monitor

- Installation monitoring is essential to detect hidden and background installations that may leave traces of application data on the system. Mirekusoft Install Monitor automatically monitors and allows complete uninstallation of software, providing detailed information about installed software and its resource usage. We can use Mirekusoft Install Monitor to identify hidden and background installations.

**Other Monitoring Tools:**
    - You can also use other installation monitoring tools such as [SysAnalyzer](https://www.aldeid.com), [Advanced Uninstaller PRO](https://www.advanceduninstaller.com), [REVO UNINSTALLER PRO](https://www.revouninstaller.com), or [Comodo Programs Manager](https://www.comodo.com) for comprehensive installation monitoring.

---

#### Perform Files and Folder Monitoring using PA File Sight

- Malware can modify system files and folders to save information in them. You should be able to find the files and folders that malware creates and analyze them to collect any relevant stored information. These files and folders may also contain hidden program code or malicious strings that the malware plans to execute on a specific schedule. An ethical hacker or penetration tester must scan the system for suspicious files and folders using file and folder monitoring tools such as PA File Sight to detect any malware installed and any system file modifications. PA File Sight is a protection and auditing tool. It detects ransomware attacks coming from a network and stops them.

**Features:**

- Compromised computers are blocked from reaching files on other protected servers on the network.
- Detects users copying files and optionally blocks access.
- Real-time alerts allow the appropriate staff to investigate immediately.
- Audits who is deleting, moving, and reading files.

**Explore Other Tools:** 
    - You can also use other file and folder integrity checking tools such as [Tripwire File Integrity and Change Manager](https://www.tripwire.com), [Netwrix Auditor](https://www.netwrix.com), Verisys ([ionx](https://www.ionx.co.uk)), or [CSP File Integrity Checker](https://www.cspsecurity.com) to perform file and folder monitoring.

---

#### Device Driver Monitoring using DriverView and Driver Reviver

- When dealing with potential malware threats, it's crucial to monitor device drivers, as they can be exploited by malware downloaded from untrusted sources. Tools like DriverView and Driver Reviver aid in scanning and verifying the authenticity of device drivers, ensuring they are genuine and obtained from the original publisher's site.

**DriverView**

- DriverView provides a comprehensive list of all currently loaded device drivers on the system. It displays essential information such as the driver's load address, description, version, product name, and developer.

**Driver Reviver**

- Driver Reviver ensures that system drivers are up-to-date, optimizing PC performance and reducing vulnerability to potential security breaches.

**Explore Other Tools:** 
    - Alternative device driver monitoring tools include [Driver Booster](https://www.iobit.com), [Driver Easy](https://www.drivereasy.com), [Driver Fusion](https://treexy.com), or [Driver Genius 22](https://www.driver-soft.com).

---

#### DNS Monitoring using DNSQuerySniffer

DNSQuerySniffer is a network sniffer utility that displays DNS queries sent on your system. It provides detailed information such as Host Name, Port Number, Query ID, Request Type, Request Time, Response Time, Duration, Response Code, Number of records, and the content of the returned DNS records. You can export the data to various file formats or copy it to the clipboard for analysis.

**Explore Other Tools:**
    - You can explore other DNS monitoring/resolution tools like [DNSstuff](https://www.dnsstuff.com) or [Sonar Lite](https://constellix.com) for additional DNS monitoring.

---
